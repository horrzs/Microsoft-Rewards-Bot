services:
  microsoft-rewards-script:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # If Docker Desktop reports "failed to stat active key during commit" in the build step,
      # retry with BuildKit disabled or prune the builder cache:
      # DOCKER_BUILDKIT=0 docker compose -f docker/compose.yaml up -d
      # docker builder prune -f
    container_name: microsoft-rewards-bot
    restart: unless-stopped

    # Volume mounts: Specify a location where you want to save the files on your local machine.
    volumes:
      - ../src/accounts.jsonc:/usr/src/microsoft-rewards-bot/accounts.jsonc:ro
      - ../src/config.jsonc:/usr/src/microsoft-rewards-bot/config.jsonc:ro
      - ../sessions:/usr/src/microsoft-rewards-bot/sessions # Optional, saves your login session
    # Optional: expose dashboard only to the host (blocks LAN access)
    # ports:
    #   - "127.0.0.1:3000:3000"

    environment:
      TZ: "America/Toronto" # Set your timezone for proper scheduling
      NODE_ENV: "production"
      CRON_SCHEDULE: "0 7,16,20 * * *" # Customize your schedule, use crontab.guru for formatting
      RUN_ON_START: "true" # Runs the script immediately on container startup
      # START_DASHBOARD: "true" # Keep the dashboard server running in the container
      # DASHBOARD_HOST: "0.0.0.0" # Required for external access to the dashboard process
      # DASHBOARD_PORT: "3000"

      # Add scheduled start-time randomization (uncomment to customize or disable, default: enabled)
      #MIN_SLEEP_MINUTES: "5"
      #MAX_SLEEP_MINUTES: "50"
      SKIP_RANDOM_SLEEP: "false"
      # Optionally set how long to wait before killing a stuck script run (prevents blocking future runs, default: 8 hours)
      #STUCK_PROCESS_TIMEOUT_HOURS: "8"

      # Optional resource limits for the container
    mem_limit: 4g
    cpus: 2

    # Health check - monitors if cron daemon is running to ensure scheduled jobs can execute
    # Container marked unhealthy if cron process dies
    healthcheck:
      test: [ "CMD", "sh", "-c", "pgrep cron > /dev/null || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Security hardening
    security_opt:
      - no-new-privileges:true
